version: '3.8'

services:
  # Backend API (Laravel)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: neverland-backend
    ports:
      - "8001:80"
      - "8081:8080"
    restart: unless-stopped
    environment:
      APP_NAME: "Neverland Studio API"
      APP_ENV: local
      APP_DEBUG: "true"
      APP_URL: http://localhost:8001
      FRONTEND_URL: http://localhost:5173
      CORS_ALLOWED_ORIGINS: "http://localhost:5173,http://localhost:3000,http://127.0.0.1:5173,http://127.0.0.1:3000"
      SANCTUM_STATEFUL_DOMAINS: "localhost:5173,localhost:3000,127.0.0.1:5173,127.0.0.1:3000"
      CORS_SUPPORTS_CREDENTIALS: "true"
      BROADCAST_CONNECTION: "reverb"
      REVERB_APP_ID: "827985"
      REVERB_APP_KEY: "asdfasdfasdf"
      REVERB_APP_SECRET: "zxcvzxcvzxcv"
      REVERB_HOST: "0.0.0.0"
      REVERB_PORT: "8080"
      REVERB_SCHEME: "http"
      DB_CONNECTION: mysql
      DB_HOST: mariadb
      DB_PORT: 3306
      DB_DATABASE: neverland_portfolio
      DB_USERNAME: root
      DB_PASSWORD: root
      SESSION_DRIVER: database
      QUEUE_CONNECTION: database
      CACHE_DRIVER: file
    volumes:
      - ./backend:/var/www/html
      - backend-storage:/var/www/html/storage
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend Development (React + Vite)
  frontend:
    image: node:20-alpine
    container_name: neverland-frontend
    working_dir: /app
    ports:
      - "5173:5173"
    restart: unless-stopped
    environment:
      NODE_ENV: development
      VITE_API_URL: ""
      VITE_BACKEND_INTERNAL: http://backend
      VITE_API_VERSION: /api/v1
      VITE_APP_NAME: Neverland Studio
      VITE_APP_URL: http://localhost:5173
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    command: sh -c "npm install && npm run dev -- --host"
    depends_on:
      - backend
    networks:
      - app-network

networks:
  app-network:
    external: true

volumes:
  backend-storage:
    driver: local
  node_modules:
    driver: local
